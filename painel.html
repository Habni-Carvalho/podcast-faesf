<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel | Podcast FAESF</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<!-- Lucide icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
:root{
  --azul:#001f36; --cinza:#ebedf0; --card:#fff; --radius:32px;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Segoe UI",Arial,sans-serif;background:var(--cinza);color:#232528;min-height:100vh}
header{background:var(--azul);color:#fff;padding:2.3rem 1rem 2rem;display:flex;align-items:center;justify-content:center;gap:.7rem;font-size:1.5rem;font-weight:700}
header svg{stroke:#fff;width:29px;height:29px}
.container{max-width:940px;margin:36px auto 20px;background:var(--card);border-radius:var(--radius);box-shadow:0 6px 28px #0002;padding:34px 28px 30px}
.tabs{display:flex;gap:10px;margin-bottom:30px}
.tab-btn{border:none;background:#f5f7f9;border:1.5px solid var(--azul);color:var(--azul);padding:8px 18px;border-radius:40px;display:flex;align-items:center;gap:6px;font-size:1rem;font-weight:600;cursor:pointer;transition:.12s}
.tab-btn.active{background:var(--azul);color:#fff}
.tab-btn i{stroke:currentColor;width:19px;height:19px}
.topo-acoes{display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:26px}
.voltar-home,.novo-botao{border:1.5px solid var(--azul);background:#fff;color:var(--azul);border-radius:10px;display:flex;align-items:center;gap:8px;padding:7px 18px;font-size:1rem;font-weight:600;cursor:pointer;transition:.13s}
.voltar-home:hover,.novo-botao:hover{background:var(--azul);color:#fff}
.voltar-home i,.novo-botao i{stroke:currentColor;width:21px;height:21px}
.tags{display:flex;flex-wrap:wrap;gap:.7rem;margin-bottom:2rem}
.tag-btn{border:1.3px solid var(--azul);background:#f6f7f9;color:var(--azul);padding:.38rem 1.3rem;border-radius:17px;font-size:.96rem;font-weight:500;cursor:pointer;transition:.1s}
.tag-btn.active,.tag-btn:hover{background:var(--azul);color:#fff}
.formulario{background:#f9fafb;border-radius:20px;padding:23px 18px 28px;margin-bottom:28px}
.formulario input,.formulario textarea{width:100%;font-size:15px;border:1px solid #d1d5db;border-radius:11px;padding:12px;margin-bottom:14px}
.formulario .btn-salvar{display:flex;justify-content:flex-end}
.formulario .btn-salvar button{border:1.5px solid var(--azul);background:#fff;color:var(--azul);border-radius:12px;padding:9px 22px;display:flex;align-items:center;gap:7px;font-size:1rem;font-weight:600;cursor:pointer;transition:.13s}
.formulario .btn-salvar button:hover{background:var(--azul);color:#fff}
.formulario .btn-salvar button i{stroke:currentColor;width:20px;height:20px}
.episodio{background:#fff;border-radius:24px;padding:20px;margin-bottom:36px;box-shadow:0 2px 9px #001f360e}
.ep-flex{display:flex;gap:20px}
.ep-img{width:150px;height:150px;object-fit:cover;border-radius:16px;box-shadow:0 2px 6px #001f3620}
.ep-content{flex:1;min-width:0}
.titulo{font-size:1.1rem;font-weight:700;color:var(--azul);margin:0 0 .2rem}
.data{font-size:.9rem;color:#777;display:flex;align-items:center;gap:9px;margin:0 0 9px}
.badge{background:#f6f8fa;border:1px solid #d4e1ef;border-radius:10px;padding:2px 9px;font-size:.85rem;color:#19598a}
.descricao{font-size:.95rem;line-height:1.45;margin:0 0 10px}
audio{width:100%;border-radius:18px;background:#f3f5f7}
.icones-laterais{display:flex;flex-direction:column;gap:15px;margin-left:16px}
.btn-icon{background:none;border:none;padding:.25rem;border-radius:8px;cursor:pointer;transition:background .1s}
.btn-icon i{stroke:var(--azul);width:23px;height:23px}
.btn-icon:hover{background:#f1f5fa}
.usuario-card{background:#fff;border-radius:18px;padding:16px 20px;margin-bottom:22px;box-shadow:0 2px 6px #001f360e}
.usuario-card strong{color:var(--azul)}
.usuario-card .grupos span{background:#eaf2ff;border:1px solid #c9def9;border-radius:8px;padding:1px 8px;margin-right:5px;font-size:.8rem;color:#19598a}
.empty{color:#888;text-align:center;margin:2rem 0;font-size:1rem}
@media(max-width:720px){
  .container{padding:1rem 2vw}
  .ep-flex{flex-direction:column;align-items:center}
  .ep-img{width:100%;height:auto;max-width:280px}
  .icones-laterais{flex-direction:row;margin:10px 0 0;gap:20px}
}
.hide { display: none !important; }
/* Botões simples para criação rápida */
.add-quick-btn { border:none; background:transparent; color:var(--azul); font-size:1.2rem; cursor:pointer; margin-left:8px; padding:2px 8px; border-radius:8px;}
.add-quick-btn:hover { background:#e2eaff; }
</style>
</head>

<body>
<header><i data-lucide="headphones"></i> Drops de Conhecimento</header>

<div class="container" id="tela-login">
  <div style="text-align:center;padding:70px 0">
      <h2 style="color:var(--azul);font-weight:500">Acesso restrito</h2>
      <button class="login-btn" onclick="loginGoogle()">
        <i data-lucide="log-in"></i> Entrar com Google
      </button>
      <div id="msgErro" class="msg-erro" style="display:none"></div>
      <p style="margin-top:1.7rem;color:#666;opacity:.75;font-size:.94rem">Somente administradores podem acessar este painel.</p>
  </div>
</div>

<div class="container hide" id="tela-painel">

  <div class="tabs">
    <button class="tab-btn active" id="tab-episodios" onclick="mostrarSecao('episodios')">
      <i data-lucide="list"></i> Episódios
    </button>
    <button class="tab-btn" id="tab-usuarios" onclick="mostrarSecao('usuarios')">
      <i data-lucide="user-plus"></i> Usuários
    </button>
  </div>

  <section id="secao-episodios" class="secao">
    <div class="topo-acoes">
      <button class="voltar-home" onclick="location.href='index.html'"><i data-lucide="chevron-left"></i>Página Pública</button>
      <button class="novo-botao" onclick="mostrarFormulario()"><i data-lucide="circle-plus"></i>Novo Episódio</button>
    </div>
    <div id="tagBar" class="tags"></div>
    <form id="formulario" class="formulario" style="display:none" onsubmit="event.preventDefault();salvarEpisodio();">
      <input id="titulo" placeholder="Título do episódio" required>
      <textarea id="descricao" placeholder="Descrição do episódio" required></textarea>
      <input id="data" type="date" required>
      <input id="tag" placeholder="Tags (ex: Notícias, EaD)" required>
      <div style="margin: 10px 0 12px 0; display: flex; align-items: center;">
        <input id="imagem" placeholder="Link da imagem (.jpg ou .png)" required style="flex:1">
      </div>
      <div style="margin-bottom:14px; display: flex; align-items: center;">
        <input id="audio" placeholder="Link do áudio (.mp3)" required style="flex:1">
      </div>
      <div class="btn-salvar"><button type="submit"><i data-lucide="save"></i>Salvar</button></div>
    </form>
    <div id="lista-episodios"></div>
    <div id="emptyEp" class="empty" style="display:none">Nenhum episódio cadastrado.</div>
  </section>

  <section id="secao-usuarios" class="secao hide">
    <div class="topo-acoes" style="margin-bottom:20px">
      <h3 style="margin:0;color:var(--azul);font-weight:600">Usuários</h3>
      <button class="novo-botao" onclick="prepararEabrirFormUsuario()">
        <i data-lucide="user-plus"></i>Novo Usuário
      </button>
    </div>
    <div id="lista-usuarios"></div>
    <div id="emptyUsu" class="empty" style="display:none">Nenhum usuário cadastrado.</div>
  </section>

  <!-- Modal Usuário -->
  <div id="modalUsuario" class="hide" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1500">
    <div style="background:#fff;border-radius:18px;padding:28px 26px;max-width:460px;width:94%;box-shadow:0 8px 26px #001f3614;position:relative">
      <h3 id="tituloModal" style="margin-top:0;color:var(--azul)">Novo usuário</h3>
      <form id="formUsuario" onsubmit="event.preventDefault();salvarUsuario();" autocomplete="off">
        <input id="u_nome" placeholder="Nome completo" required>
        <input id="u_email" placeholder="E-mail" type="email" required>
        <input id="u_cargo" placeholder="Cargo / Função" required>
        <div style="margin:14px 0 8px;font-weight:600;color:var(--azul);display:flex;align-items:center">
          Grupos
          <button type="button" class="add-quick-btn" title="Novo Grupo" onclick="abrirModalGrupo()"><i data-lucide='plus'></i></button>
        </div>
        <div id="checkGrupos" style="display:flex;flex-wrap:wrap;gap:12px"></div>
        <div style="margin:18px 0 8px;font-weight:600;color:var(--azul);display:flex;align-items:center">
          Playlists
          <button type="button" class="add-quick-btn" title="Nova Playlist" onclick="abrirModalPlaylist()"><i data-lucide='plus'></i></button>
        </div>
        <div id="checkPlaylists" style="display:flex;flex-wrap:wrap;gap:12px"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:22px;gap:10px">
          <button type="button" class="voltar-home" onclick="fecharModalUsuario()">
            <i data-lucide="x"></i>Cancelar
          </button>
          <button class="novo-botao" type="submit">
            <i data-lucide="save"></i>Salvar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Grupo -->
  <div id="modalGrupo" class="hide" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1700">
    <div style="background:#fff;border-radius:15px;padding:26px 20px;width:340px;max-width:96vw;box-shadow:0 6px 22px #001f3614;">
      <h3 style="margin-top:0;font-size:1.15rem;color:var(--azul)">Novo Grupo</h3>
      <form onsubmit="event.preventDefault();salvarGrupo();">
        <input id="novoGrupo" placeholder="Nome do grupo" required autofocus>
        <div style="display:flex;justify-content:flex-end;margin-top:18px;gap:9px">
          <button type="button" class="voltar-home" onclick="fecharModalGrupo()"><i data-lucide='x'></i>Cancelar</button>
          <button class="novo-botao" type="submit"><i data-lucide='save'></i>Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Playlist -->
  <div id="modalPlaylist" class="hide" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:1700">
    <div style="background:#fff;border-radius:15px;padding:26px 20px;width:340px;max-width:96vw;box-shadow:0 6px 22px #001f3614;">
      <h3 style="margin-top:0;font-size:1.15rem;color:var(--azul)">Nova Playlist</h3>
      <form onsubmit="event.preventDefault();salvarPlaylist();">
        <input id="novaPlaylist" placeholder="Nome da playlist" required autofocus>
        <div style="display:flex;justify-content:flex-end;margin-top:18px;gap:9px">
          <button type="button" class="voltar-home" onclick="fecharModalPlaylist()"><i data-lucide='x'></i>Cancelar</button>
          <button class="novo-botao" type="submit"><i data-lucide='save'></i>Salvar</button>
        </div>
      </form>
    </div>
  </div>

</div>

<div id="toast" style="display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--azul);color:#fff;padding:.75rem 1.6rem;border-radius:12px;font-size:.95rem;box-shadow:0 2px 8px #001f3645;z-index:2000"></div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyCiXyKgy5sw26JWPLZBX6SFVLbBDrLOCZw",
  authDomain:"podcasts-faesf-72959.firebaseapp.com",
  projectId:"podcasts-faesf-72959",
  storageBucket:"podcasts-faesf-72959.appspot.com",
  messagingSenderId:"1097331767383",
  appId:"1:1097331767383:web:7e4228ea735c5365cd4b12"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const ADMINS = ["hpc@faesf.com.br"];

function loginGoogle(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
      .catch(e=>alert("Erro no login: "+e.message));
}
auth.onAuthStateChanged(user=>{
  if(user && ADMINS.includes(user.email)){
     document.getElementById('tela-login').classList.add('hide');
     document.getElementById('tela-painel').classList.remove('hide');
     mostrarSecao('episodios');
  }else{
     document.getElementById('tela-login').classList.remove('hide');
     document.getElementById('tela-painel').classList.add('hide');
  }
});

function mostrarSecao(qual){
  document.querySelectorAll('.secao').forEach(s=>s.classList.add('hide'));
  document.querySelector('#secao-'+qual).classList.remove('hide');
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('#tab-'+qual).classList.add('active');
  if(qual==='episodios') carregarEpisodios();
  if(qual==='usuarios')  carregarUsuarios();
}

function toast(msg){
  const el = document.getElementById('toast');
  el.textContent=msg; el.style.display='block';
  setTimeout(()=>el.style.display='none',2200);
}

/* ---------- CRUD EPISÓDIOS ---------- */
let todos=[], editandoId=null, tagAtual="Todas";
function carregarEpisodios(){
  db.collection('episodios').orderBy('criadoEm','desc').get().then(q=>{
    todos=[]; q.forEach(d=>todos.push({...d.data(),id:d.id}));
    renderTags(); renderLista();
  });
}
function renderTags(){
  const set=new Set(); todos.forEach(ep=>(ep.tags||"").split(',').forEach(t=>t.trim()&&set.add(t.trim())));
  const barra=document.getElementById('tagBar'); barra.innerHTML='';
  ['Todas',...set].forEach(t=>{
     const b=document.createElement('button');
     b.className='tag-btn'+(t===tagAtual?' active':'');
     b.textContent=t||'Sem tag';
     b.onclick=()=>{tagAtual=t;renderTags();renderLista()};
     barra.appendChild(b);
  });
}
function renderLista(){
  const box=document.getElementById('lista-episodios'); box.innerHTML='';
  const lista=todos.filter(e=>tagAtual==='Todas'||(e.tags||"").split(',').map(s=>s.trim()).includes(tagAtual));
  document.getElementById('emptyEp').style.display=lista.length?'none':'block';
  lista.forEach(ep=>{
     const card=document.createElement('div'); card.className='episodio';
     card.innerHTML=`
      <div class="ep-flex">
         <img class="ep-img" src="${ep.imagem}">
         <div class="ep-content">
           <div class="titulo">${ep.titulo}</div>
           <p class="data"><i data-lucide="calendar"></i>${ep.data}</p>
           <p class="descricao">${ep.descricao}</p>
           <audio controls src="${ep.audio}"></audio>
         </div>
         <div class="icones-laterais">
           <button class="btn-icon" onclick='mostrarFormulario(${JSON.stringify(ep)}, "${ep.id}")' title="Editar"><i data-lucide="square-pen"></i></button>
           <button class="btn-icon" onclick='excluirEpisodio("${ep.id}")'  title="Excluir"><i data-lucide="trash-2"></i></button>
         </div>
      </div>`;
     box.appendChild(card);
  });
  lucide.createIcons();
}

async function mostrarFormulario(ep=null,id=null){
  editandoId=id;
  const f=document.getElementById('formulario'); f.style.display='block';
  f.titulo.value=ep?.titulo||''; f.descricao.value=ep?.descricao||'';
  f.data.value=ep?.data||''; f.tag.value=ep?.tags||'';
  f.imagem.value=ep?.imagem||''; f.audio.value=ep?.audio||'';
  f.titulo.focus();
}

async function salvarEpisodio(){
  const f=document.getElementById('formulario');
  // Playlists do episódio
  let tagsPlaylist = (f.tag.value.trim() || '').split(',').map(t=>t.trim()).filter(Boolean);
  // Confirma se cada tag existe em playlists (caso não exista, cria)
  for (const nome of tagsPlaylist) {
    if (nome) {
      let snap = await db.collection('playlists').where('nome', '==', nome).get();
      if (snap.empty) {
        await db.collection('playlists').add({nome: nome});
      }
    }
  }
  const dados={titulo:f.titulo.value.trim(),descricao:f.descricao.value.trim(),data:f.data.value,
               tags:f.tag.value.trim(),imagem:f.imagem.value.trim(),audio:f.audio.value.trim(),
               criadoEm:firebase.firestore.Timestamp.now()};
  const ref=db.collection('episodios');
  (editandoId?ref.doc(editandoId).set(dados):ref.add(dados))
     .then(()=>{toast('Salvo com sucesso');f.reset();f.style.display='none';carregarEpisodios();editandoId=null});
}
function excluirEpisodio(id){
  if(confirm('Excluir episódio?')) db.collection('episodios').doc(id).delete().then(()=>carregarEpisodios());
}

/* ---------- CRUD USUÁRIOS, GRUPOS E PLAYLISTS ---------- */
let editUserId = null;

// Busca atualizada antes de abrir o modal usuário
async function prepararEabrirFormUsuario(user=null){
  const [snapGrup, snapPlay] = await Promise.all([
    db.collection('grupos').get(),
    db.collection('playlists').get()
  ]);
  window.TODOS_GRUPOS = snapGrup.docs.map(d=>d.data().nome);
  window.TODOS_PL = snapPlay.docs.map(d=>d.data().nome);

  abrirFormUsuario(user);
}

function carregarUsuarios(){
  db.collection('usuarios').get().then(snapUsu=>{
     const box=document.getElementById('lista-usuarios'); box.innerHTML='';
     if(snapUsu.empty){document.getElementById('emptyUsu').style.display='block';return}
     document.getElementById('emptyUsu').style.display='none';
     snapUsu.forEach(doc=>{
        const u=doc.data();
        const card=document.createElement('div');
        card.className='usuario-card';
        card.innerHTML=`
           <strong>${u.nome||'(sem nome)'}</strong> — ${u.cargo||''}<br>
           <span style="font-size:.82rem;color:#666">${u.email}</span>
           <div class="grupos" style="margin-top:6px">${(u.grupos||[])
             .map(g=>`<span>${g}</span>`).join(' ')}</div>
           <button class="btn-icon" style="position:absolute;top:14px;right:48px"
                   title="Editar" onclick='prepararEabrirFormUsuario(${JSON.stringify({id:doc.id,...u})})'>
              <i data-lucide="square-pen"></i>
           </button>
           <button class="btn-icon" style="position:absolute;top:14px;right:14px"
                   title="Excluir" onclick='excluirUsuario("${doc.id}")'>
              <i data-lucide="trash-2"></i>
           </button>`;
        card.style.position='relative';
        box.appendChild(card);
     });
     lucide.createIcons();
  });
}

function abrirFormUsuario(user=null){
  editUserId = user?.id || null;
  document.getElementById('tituloModal').textContent= editUserId?'Editar usuário':'Novo usuário';
  document.getElementById('u_nome').value=user?.nome||'';
  document.getElementById('u_email').value=user?.email||'';
  document.getElementById('u_cargo').value=user?.cargo||'';
  gerarChecks('checkGrupos',window.TODOS_GRUPOS||[],user?.grupos||[]);
  gerarChecks('checkPlaylists',window.TODOS_PL||[],user?.playlists||[]);
  document.getElementById('modalUsuario').classList.remove('hide');
  lucide.createIcons();
}
function gerarChecks(destId,todas,marcadas){
  const box=document.getElementById(destId); box.innerHTML='';
  todas.forEach(nome=>{
    const id=destId+nome;
    box.insertAdjacentHTML('beforeend',`
      <label style="display:flex;align-items:center;gap:6px;font-size:.9rem">
        <input type="checkbox" id="${id}" ${marcadas && marcadas.includes(nome)?'checked':''}>
        <span>${nome}</span>
      </label>`);
  });
}
function fecharModalUsuario(){
  document.getElementById('modalUsuario').classList.add('hide');
}
function salvarUsuario(){
  const grupos=Array.from(document.querySelectorAll('#checkGrupos input:checked')).map(c=>c.nextElementSibling.textContent);
  const pls   =Array.from(document.querySelectorAll('#checkPlaylists input:checked')).map(c=>c.nextElementSibling.textContent);
  const u={ nome:u_nome.value.trim(),
            email:u_email.value.trim(),
            cargo:u_cargo.value.trim(),
            grupos, playlists:pls };
  const ref=db.collection('usuarios');
  (editUserId?ref.doc(editUserId).set(u):ref.add(u))
     .then(()=>{toast('Salvo');fecharModalUsuario();carregarUsuarios()});
}
function excluirUsuario(id){
  if(confirm('Excluir usuário?')) db.collection('usuarios').doc(id).delete().then(()=>carregarUsuarios());
}

/* ---------- GRUPOS ---------- */
function abrirModalGrupo(){
  document.getElementById('modalGrupo').classList.remove('hide');
  document.getElementById('novoGrupo').value='';
  setTimeout(()=>{document.getElementById('novoGrupo').focus()},200);
  lucide.createIcons();
}
function fecharModalGrupo(){
  document.getElementById('modalGrupo').classList.add('hide');
}
function salvarGrupo(){
  const nome = document.getElementById('novoGrupo').value.trim();
  if(!nome) return;
  db.collection('grupos').add({nome})
    .then(()=>{toast('Grupo salvo!');fecharModalGrupo(); prepararEabrirFormUsuario();});
}

/* ---------- PLAYLISTS ---------- */
function abrirModalPlaylist(){
  document.getElementById('modalPlaylist').classList.remove('hide');
  document.getElementById('novaPlaylist').value='';
  setTimeout(()=>{document.getElementById('novaPlaylist').focus()},200);
  lucide.createIcons();
}
function fecharModalPlaylist(){
  document.getElementById('modalPlaylist').classList.add('hide');
}
function salvarPlaylist(){
  const nome = document.getElementById('novaPlaylist').value.trim();
  if(!nome) return;
  db.collection('playlists').add({nome})
    .then(()=>{toast('Playlist salva!');fecharModalPlaylist(); prepararEabrirFormUsuario();});
}

document.addEventListener('DOMContentLoaded',() => {
  lucide.createIcons();
});
</script>
<script>lucide.createIcons();</script>
</body>
</html>
